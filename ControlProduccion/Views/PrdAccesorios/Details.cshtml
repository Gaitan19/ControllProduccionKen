@using ControlProduccion.ViewModel;
@model PrdAccesorioViewModel;
@{
    ViewData["Title"] = "Detalles Producción Accesorios";
}

<div class="col-md-8 offset-md-2">
    <div class="ibox ">
        <div class="ibox-title">
            <h5>@ViewData["Title"] </h5>
        </div>
        <div class="ibox-content">
            <form autocomplete="off">
                @Html.AntiForgeryToken()

                <div class="form-group">
                    <label asp-for="IdUsuarios"></label>
                    <select multiple asp-for="IdUsuarios" class="form-control select2" asp-items="Model.Operarios" disabled>
                    </select>
                </div>
                <div class="form-group">
                    <label asp-for="IdMaquina"></label>
                    <select asp-for="IdMaquina" class="form-control select2" asp-items="Model.Maquinas" disabled>
                    </select>
                </div>
                <div class="form-group">
                    <label asp-for="Fecha"></label>
                    <input asp-for="Fecha" class="form-control" readonly />
                </div>
                <div class="form-group">
                    <label asp-for="TiempoParo"></label>
                    <input asp-for="TiempoParo" class="form-control" readonly />
                </div>

                <!-- Campos de Merma -->
                <div class="hr-line-dashed"></div>
                <h4>Mermas</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaMallaCovintecKg"></label>
                            <input asp-for="MermaMallaCovintecKg" class="form-control" readonly />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaMallaPchKg"></label>
                            <input asp-for="MermaMallaPchKg" class="form-control" readonly />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaBobinasKg"></label>
                            <input asp-for="MermaBobinasKg" class="form-control" readonly />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaLitewallKg"></label>
                            <input asp-for="MermaLitewallKg" class="form-control" readonly />
                        </div>
                    </div>
                </div>

                <div class="hr-line-dashed"></div>
                <div class="form-group row">
                    <div class="col-sm-12" style="max-height: 400px; overflow: scroll">
                        <h4>Detalle Producción</h4>

                        <table id="tblProduccion" class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo Artículo</th>
                                    <th>Artículo</th>
                                    <th>Tipo Fabricación</th>
                                    <th>No. Pedido</th>
                                    <th>Malla Covintec</th>
                                    <th>Cant. Malla (Un)</th>
                                    <th>Tipo Malla PCH</th>
                                    <th>Cant. PCH (Kg)</th>
                                    <th>Ancho Bobina</th>
                                    <th>Cant. Bobina (Kg)</th>
                                    <th>Calibre</th>
                                    <th>Cant. Calibre (Kg)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.DetPrdAccesorios != null)
                                {
                                    @foreach (var detalle in Model.DetPrdAccesorios)
                                    {
                                        <tr>
                                            <td data-field="tipoarticulo">@detalle.TipoArticulo</td>
                                            <td data-field="articulo">
                                                @(detalle.TipoArticulo == "COVINTEC" ? "" : detalle.Articulo)
                                            </td>
                                            <td>@detalle.TipoFabricacion</td>
                                            <td>@detalle.NumeroPedido</td>
                                            <td>@detalle.MallaCovintec</td>
                                            <td>@detalle.CantidadMallaUn</td>
                                            <td>@detalle.TipoMallaPch</td>
                                            <td>@detalle.CantidadPchKg</td>
                                            <td>@detalle.AnchoBobina</td>
                                            <td>@detalle.CantidadBobinaKg</td>
                                            <td>@detalle.Calibre</td>
                                            <td>@detalle.CantidadCalibreKg</td>

                                            <!-- ocultos -->
                                            <td style="display:none" data-field="idTipoArticulo">@detalle.IdTipoArticulo</td>
                                            <td style="display:none" data-field="idArticulo">@detalle.IdArticulo</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Observaciones"></label>
                    <textarea asp-for="Observaciones" class="form-control" rows="3" readonly></textarea>
                </div>

                <div class="form-group">
                    <label asp-for="NotaSupervisor"></label>
                    @if (User.IsInRole("Supervisor"))
                    {
                        <textarea id="txtNotaSupervisor" asp-for="NotaSupervisor" class="form-control" rows="3" placeholder="Ingrese la nota del supervisor..."></textarea>
                        <span asp-validation-for="NotaSupervisor" class="text-danger"></span>
                    }
                    else
                    {
                        <textarea asp-for="NotaSupervisor" class="form-control" rows="3" readonly></textarea>
                    }
                </div>

                <div class="hr-line-dashed"></div>


                <button type="button" class="btn btn-dark" onclick="location.href='@Url.Action("Index", "PrdAccesorios")'">Regresar</button>
                @if (User.IsInRole("Supervisor"))
                {
                    <button id="btnGuardarNota" type="button" class="btn btn-primary">Guardar Nota</button>
                    @if (Model.AprobadoSupervisor != true)
                    {
                        <button id="btnValidarProd" type="button" class="btn btn-danger">Validar</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-success">Validado</button>
                    }
                }
                else
                {
                    <button type="button" class="btn btn-success">Validado</button>
                }
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        $(document).ready(function () {
            // Inicializar select2 deshabilitado
            $('.select2').select2({
                width: '100%'
            });

            // Botón validar
            $('#btnValidarProd').click(function () {
                if (confirm('¿Está seguro que desea validar esta producción?')) {
                    var token = $('input[name="__RequestVerificationToken"]').val();
                    var id = @Model.Id;

                    $.ajax({
                        url: '@Url.Action("ValidarPrd", "PrdAccesorios")',
                        type: 'POST',
                        data: { id: id },
                        headers: {
                            'RequestVerificationToken': token
                        },
                        success: function (response) {
                            if (response) {
                                alert('Producción validada exitosamente');
                                location.reload();
                            } else {
                                alert('No se pudo validar la producción');
                            }
                        },
                        error: function () {
                            alert('Error al validar la producción');
                        }
                    });
                }
            });

            // Botón guardar nota
            $('#btnGuardarNota').click(function () {
                var notaSupervisor = $('#txtNotaSupervisor').val();
                var token = $('input[name="__RequestVerificationToken"]').val();
                var id = @Model.Id;

                $.ajax({
                    url: '@Url.Action("SaveNotaSupervisor", "PrdAccesorios")',
                    type: 'POST',
                    data: { 
                        id: id, 
                        notaSupervisor: notaSupervisor 
                    },
                    headers: {
                        'RequestVerificationToken': token
                    },
                    success: function (response) {
                        if (response && response.success) {
                            alert('Nota guardada exitosamente');
                        } else {
                            alert(response.message || 'Error al guardar la nota');
                        }
                    },
                    error: function () {
                        alert('Error al guardar la nota');
                    }
                });
            });

        });



        function hydrateArticuloColumn() {
            var grupos = {};

            $('#tblProduccion tbody tr').each(function () {
                var $row = $(this);
                if ($row.find("td[data-field='articulo']").text().trim()) return;

                var tipoId = $row.find("td[data-field='idTipoArticulo']").text().trim();
                var artId = $row.find("td[data-field='idArticulo']").text().trim();
                if (!tipoId || !artId) return;

                (grupos[tipoId] = grupos[tipoId] || []).push({ row: $row, artId: String(artId) });
            });

            var requests = Object.keys(grupos).map(function (tipoId) {
                return $.getJSON('@Url.Action("GetArticulosByTipo", "PrdAccesorios")', { idTipoArticulo: tipoId })
                    .done(function (data) {
                        var dict = {};
                        (data || []).forEach(function (it) { dict[String(it.id)] = it.texto; });

                        grupos[tipoId].forEach(function (x) {
                            var tipoTexto = x.row.find("td[data-field='tipoarticulo']").text().trim().toUpperCase();
                            var nombre = (tipoTexto === "COVINTEC") ? "" : (dict[x.artId] || '');
                            x.row.find("td[data-field='articulo']").text(nombre);
                        });
                    });
            });

            if (requests.length) { $.when.apply($, requests); }
        }

        $(document).ready(function () {
            hydrateArticuloColumn();
        });
    </script>
}
