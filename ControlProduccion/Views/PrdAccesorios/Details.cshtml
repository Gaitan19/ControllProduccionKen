@using ControlProduccion.ViewModel;
@model PrdAccesorioViewModel;
@{
    ViewData["Title"] = "Detalles Producción Accesorios";
}

<div class="col-md-8 offset-md-2">
    <div class="ibox ">
        <div class="ibox-title">
            <h5>@ViewData["Title"] </h5>
        </div>
        <div class="ibox-content">
            <form autocomplete="off">
                @Html.AntiForgeryToken()

                <div class="form-group">
                    <label asp-for="IdUsuarios"></label>
                    <select multiple asp-for="IdUsuarios" class="form-control select2" asp-items="Model.Operarios" disabled>
                    </select>
                </div>
                <div class="form-group">
                    <label asp-for="IdMaquina"></label>
                    <select asp-for="IdMaquina" class="form-control select2" asp-items="Model.Maquinas" disabled>
                    </select>
                </div>
                <div class="form-group">
                    <label asp-for="Fecha"></label>
                    <input asp-for="Fecha" class="form-control" readonly />
                </div>
                <div class="form-group">
                    <label asp-for="TiempoParo"></label>
                    <input asp-for="TiempoParo" class="form-control" readonly />
                </div>

                <!-- Campos de Merma -->
                <div class="hr-line-dashed"></div>
                <h4>Mermas</h4>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaMallaCovintecKg"></label>
                            <input asp-for="MermaMallaCovintecKg" class="form-control" readonly />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaMallaPchKg"></label>
                            <input asp-for="MermaMallaPchKg" class="form-control" readonly />
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaBobinasKg"></label>
                            <input asp-for="MermaBobinasKg" class="form-control" readonly />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label asp-for="MermaLitewallKg"></label>
                            <input asp-for="MermaLitewallKg" class="form-control" readonly />
                        </div>
                    </div>
                </div>

                <div class="hr-line-dashed"></div>
                <div class="form-group row">
                    <div class="col-sm-12" style="max-height: 400px; overflow: scroll">
                        <h4>Detalle Producción</h4>

                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo Artículo</th>
                                    <th>Artículo</th>
                                    <th>Tipo Fabricación</th>
                                    <th>No. Pedido</th>
                                    <th>Malla Covintec</th>
                                    <th>Cant. Malla (Un)</th>
                                    <th>Tipo Malla PCH</th>
                                    <th>Cant. PCH (Kg)</th>
                                    <th>Ancho Bobina</th>
                                    <th>Cant. Bobina (Kg)</th>
                                    <th>Calibre</th>
                                    <th>Cant. Calibre (Kg)</th>
                                  
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.DetPrdAccesorios != null)
                                {
                                    @foreach (var detalle in Model.DetPrdAccesorios)
                                    {
                                        <tr>
                                            <td>@detalle.TipoArticulo</td>
                                            <td>@(string.Equals(detalle.TipoArticulo?.Trim(), "COVINTEC", StringComparison.OrdinalIgnoreCase) ? "" : detalle.Articulo)</td>
                                            <td>@detalle.TipoFabricacion</td>
                                            <td>@detalle.NumeroPedido</td>
                                            <td>@detalle.MallaCovintec</td>
                                            <td>@detalle.CantidadMallaUn</td>
                                            <td>@detalle.TipoMallaPch</td>
                                            <td>@detalle.CantidadPchKg</td>
                                            <td>@detalle.AnchoBobina</td>
                                            <td>@detalle.CantidadBobinaKg</td>
                                            <td>@detalle.Calibre</td>
                                            <td>@detalle.CantidadCalibreKg</td>
                                         
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Observaciones"></label>
                    <textarea asp-for="Observaciones" class="form-control" rows="3" readonly></textarea>
                </div>

                <div class="hr-line-dashed"></div>



                <button type="button" class="btn btn-dark" onclick="location.href='@Url.Action("Index", "PrdAccesorios")'">Regresar</button>
                @if (User.IsInRole("Supervisor") && Model.AprobadoSupervisor != true)
                {
                    <button id="btnValidarProd" type="button" class="btn btn-danger" >Validar</button>
                }
                else
                {
                    <button type="button" class="btn btn-success">Validado</button>
                }

               
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function(){
            // Inicializar select2 deshabilitado
            $('.select2').select2({
                width: '100%'
            });

            // Botón validar
            $('#btnValidarProd').click(function(){
                if(confirm('¿Está seguro que desea validar esta producción?')) {
                    var token = $('input[name="__RequestVerificationToken"]').val();
                    var id = @Model.Id;
                    
                    $.ajax({
                        url: '@Url.Action("ValidarPrd", "PrdAccesorios")',
                        type: 'POST',
                        data: { id: id },
                        headers: {
                            'RequestVerificationToken': token
                        },
                        success: function(response) {
                            if(response) {
                                alert('Producción validada exitosamente');
                                location.reload();
                            } else {
                                alert('No se pudo validar la producción');
                            }
                        },
                        error: function() {
                            alert('Error al validar la producción');
                        }
                    });
                }
            });

           
           
        });
    </script>
}