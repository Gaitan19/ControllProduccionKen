@using ControlProduccion.ViewModel;
@model PrdAccesorioViewModel;
@{
    ViewData["Title"] = "Detalles Producción Accesorios";
}

<div class="col-md-8 offset-md-2">
    <div class="ibox ">
        <div class="ibox-title">
            <h5>@ViewData["Title"] </h5>
        </div>
        <div class="ibox-content">
            <form autocomplete="off">
                @Html.AntiForgeryToken()

                <!-- Campos de cabecera igual que tenías -->
                ...

                <div class="hr-line-dashed"></div>
                <div class="form-group row">
                    <div class="col-sm-12" style="max-height: 400px; overflow: scroll">
                        <h4>Detalle Producción</h4>

                        <table id="tblProduccion" class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Tipo Artículo</th>
                                    <th>Artículo</th>
                                    <th>Tipo Fabricación</th>
                                    <th>No. Pedido</th>
                                    <th>Malla Covintec</th>
                                    <th>Cant. Malla (Un)</th>
                                    <th>Tipo Malla PCH</th>
                                    <th>Cant. PCH (Kg)</th>
                                    <th>Ancho Bobina</th>
                                    <th>Cant. Bobina (Kg)</th>
                                    <th>Calibre</th>
                                    <th>Cant. Calibre (Kg)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.DetPrdAccesorios != null)
                                {
                                    @foreach (var detalle in Model.DetPrdAccesorios)
                                    {
                                        <tr>
                                            <td data-field="tipoarticulo">@detalle.TipoArticulo</td>
                                            <td data-field="articulo">
                                                @(detalle.TipoArticulo == "COVINTEC" ? "" : detalle.Articulo)
                                            </td>
                                            <td>@detalle.TipoFabricacion</td>
                                            <td>@detalle.NumeroPedido</td>
                                            <td>@detalle.MallaCovintec</td>
                                            <td>@detalle.CantidadMallaUn</td>
                                            <td>@detalle.TipoMallaPch</td>
                                            <td>@detalle.CantidadPchKg</td>
                                            <td>@detalle.AnchoBobina</td>
                                            <td>@detalle.CantidadBobinaKg</td>
                                            <td>@detalle.Calibre</td>
                                            <td>@detalle.CantidadCalibreKg</td>

                                            <!-- ocultos -->
                                            <td style="display:none" data-field="idTipoArticulo">@detalle.IdTipoArticulo</td>
                                            <td style="display:none" data-field="idArticulo">@detalle.IdArticulo</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- resto igual -->
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function hydrateArticuloColumn() {
            var grupos = {};

            $('#tblProduccion tbody tr').each(function () {
                var $row = $(this);
                if ($row.find("td[data-field='articulo']").text().trim()) return;

                var tipoId = $row.find("td[data-field='idTipoArticulo']").text().trim();
                var artId = $row.find("td[data-field='idArticulo']").text().trim();
                if (!tipoId || !artId) return;

                (grupos[tipoId] = grupos[tipoId] || []).push({ row: $row, artId: String(artId) });
            });

            var requests = Object.keys(grupos).map(function (tipoId) {
                return $.getJSON('@Url.Action("GetArticulosByTipo", "PrdAccesorios")', { idTipoArticulo: tipoId })
                    .done(function (data) {
                        var dict = {};
                        (data || []).forEach(function (it) { dict[String(it.id)] = it.texto; });

                        grupos[tipoId].forEach(function (x) {
                            var tipoTexto = x.row.find("td[data-field='tipoarticulo']").text().trim().toUpperCase();
                            var nombre = (tipoTexto === "COVINTEC") ? "" : (dict[x.artId] || '');
                            x.row.find("td[data-field='articulo']").text(nombre);
                        });
                    });
            });

            if (requests.length) { $.when.apply($, requests); }
        }

        $(document).ready(function () {
            hydrateArticuloColumn();
        });
    </script>
}
