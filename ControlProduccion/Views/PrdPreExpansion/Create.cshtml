
@using ControlProduccion.ViewModel
@model PrdPreExpansionViewModel
@{
    ViewData["Title"] = "Ingresar Producción Pre-Expansión";
}
<div class="col-md-8 offset-md-2">
    <div class="ibox">
        <div class="ibox-title">
            <h5>@ViewData["Title"]</h5>
        </div>
        <div class="ibox-content">
            <form id="frmProduccion" method="post" autocomplete="off">
                @Html.AntiForgeryToken()

                <div class="form-group">
                    <label asp-for="IdUsuarios"></label>
                    <select id="IdUsuarios" multiple asp-for="IdUsuarios" class="form-control select2" asp-items="Model.Operarios"></select>
                </div>

                <div class="form-group">
                    <label asp-for="IdMaquina"></label>
                    <select id="IdMaquina" asp-for="IdMaquina" class="form-control select2" asp-items="Model.Maquinas">
                        <option value="">-- Seleccione Máquina --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label asp-for="Fecha"></label>
                    <input asp-for="Fecha" class="form-control" />
                </div>

                <div class="form-group">
                    <label asp-for="HoraInicio"></label>
                    <input asp-for="HoraInicio" type="time"  class="form-control" />
                </div>

                <div class="form-group">
                    <label asp-for="HoraFin"></label>
                    <input asp-for="HoraFin" type="time"  class="form-control" />
                </div>

                <div class="form-group">
                    <label asp-for="PresionCaldera"></label>
                    <input asp-for="PresionCaldera" class="form-control" />
                </div>

                @* TODO: These fields have moved to PreDetPrdpreExpansion level - implement hierarchical editing *@
                @*
                <div class="form-group">
                    <label asp-for="Lote"></label>
                    <input asp-for="Lote" class="form-control" />
                </div>

                <div class="form-group">
                    <label asp-for="FechaProduccion"></label>
                    <input asp-for="FechaProduccion" class="form-control" />
                </div>

                <div class="form-group">
                    <label asp-for="CodigoSaco"></label>
                    <input asp-for="CodigoSaco" class="form-control" />
                </div>
                *@

                <div class="form-group">
                    <label asp-for="IdTipoFabricacion"></label>
                    <select id="IdTipoFabricacion" asp-for="IdTipoFabricacion" class="form-control select2" asp-items="Model.TiposFabricacion">
                        <option value="">-- Seleccione Tipo --</option>
                    </select>
                </div>

                <div class="form-group" id="divNumeroPedido" style="display:none">
                    <label asp-for="NumeroPedido"></label>
                    <input asp-for="NumeroPedido" class="form-control" min="0" step="1" />
                </div>

                <div class="form-group">
                    <label asp-for="TiempoParo"></label>
                    <input asp-for="TiempoParo" class="form-control" min="0" step="0.01" />
                </div>

    @*             <div class="form-group">
                    <label asp-for="IdTipoReporte"></label>
                    <select id="IdTipoReporte" asp-for="IdTipoReporte" class="form-control select2" asp-items="Model.TiposReporte">
                        <option value="">-- Seleccione Tipo de Reporte --</option>
                    </select>
                </div> *@

                <div class="hr-line-dashed"></div>
                <div class="form-group row">
                    <a data-toggle='modal' href='#modal-Detalle' id="btnAgregarDetalle" class="btn btn-info btn-outline">
                        <i class="fa fa-plus"></i> Agregar Detalle
                    </a>
                    <div class="col-sm-12" style="max-height:300px;overflow:scroll">
                        <h4>Detalle Producción</h4>
                        <table id="tblDetalle" class="table table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Posición</th>
                                    <th>Marca/Tipo</th>
                                    <th>Código Saco</th>
                                    <th>Lote</th>
                                    <th>Fecha Producción</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label asp-for="Observaciones"></label>
                    <textarea asp-for="Observaciones" id="Observaciones" class="form-control" rows="3"></textarea>
                    <span asp-validation-for="Observaciones" class="text-danger"></span>
                </div>

                <button type="submit" class="btn btn-primary">Guardar</button>
                <button type="button"
                        id="btnRegresar"
                        class="btn btn-dark"
                        data-url="@Url.Action("Index", "PrdPreExpansion")">
                    Regresar
                </button>
            </form>

            <!-- modal detalle -->
            <div id="modal-Detalle" class="modal fade" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-body">
                            <form id="frmDetPrd">
                                <h3>Nuevo Detalle</h3>
                                <hr />
                                <div class="mb-3">
                                    <label class="form-label">Marca/Tipo <span class="text-danger">*</span></label>
                                    <input type="text" id="MarcaTipo" class="form-control" maxlength="200" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Código Saco</label>
                                    <input type="text" id="CodigoSaco" class="form-control" maxlength="50" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Lote</label>
                                    <input type="text" id="Lote" class="form-control" maxlength="50" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Fecha Producción</label>
                                    <input type="date" id="FechaProduccion" class="form-control" />
                                </div>
                            </form>
                            <button id="btnGuardarDetPrd" type="button" class="btn btn-primary">Agregar</button>
                            <button type="button" class="btn btn-dark" data-dismiss="modal">Cancelar</button>
                            <p id="spnbtnGuardarDetPrd" class="text-sm text-danger"></p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- modal subdetalle -->
            <div id="modal-SubDetalle" class="modal fade" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-body">
                            <form id="frmSubDetPrd">
                                <h3>Nuevo Sub Detalle</h3>
                                <hr />
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">No. Batch <span class="text-danger">*</span></label>
                                            <input readonly type="number" id="NoBatch" class="form-control" min="0" step="1" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Hora <span class="text-danger">*</span></label>
                                            <input readonly type="time" id="Hora" class="form-control" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Densidad Esperada <span class="text-danger">*</span></label>
                                            <input type="number" id="DensidadEsperada" class="form-control" min="0" step="1" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Peso Batch (g) <span class="text-danger">*</span></label>
                                            <input type="number" id="PesoBatchGr" class="form-control" min="0" step="0.01" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Densidad <span class="text-danger">*</span></label>
                                            <input type="number" id="Densidad" class="form-control" min="0" step="0.01" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Kg por Batch <span class="text-danger">*</span></label>
                                            <input type="number" id="KgPorBatch" class="form-control" min="0" step="1" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Presión (psi) <span class="text-danger">*</span></label>
                                            <input type="number" id="PresionPsi" class="form-control" min="0" step="1" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Tiempo Batch (seg) <span class="text-danger">*</span></label>
                                            <input type="number" id="TiempoBatchSeg" class="form-control" min="0" step="1" />
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Temperatura (°C) <span class="text-danger">*</span></label>
                                            <input type="number" id="TemperaturaC" class="form-control" min="0" step="1" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label">Silo <span class="text-danger">*</span></label>
                                            <input type="number" id="Silo" class="form-control" min="1" step="1" />
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Paso <span class="text-danger">*</span></label>
                                    <select id="Paso" class="form-control">
                                        <option value="1">Primer Paso</option>
                                        <option value="2">Segundo Paso</option>
                                    </select>
                                </div>
                            </form>
                            <button id="btnGuardarSubDetPrd" type="button" class="btn btn-primary">Agregar</button>
                            <button type="button" class="btn btn-dark" data-dismiss="modal">Cancelar</button>
                            <p id="spnSubDet" class="text-sm text-danger"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function () {
            // ─────────── AUTOSAVE / RESTORE /PREVENT EXIT───────────
            const DRAFT_KEY = 'draft-prdPreExpansion';

            function backupForm() {
                const formArr = $('#frmProduccion').serializeArray();
                const detalleHtml = $('#tblDetalle tbody').html();
                localStorage.setItem(DRAFT_KEY,
                    JSON.stringify({ form: formArr, detalleHtml: detalleHtml })
                );
            }

            function restoreIfExists() {
                const draftStr = localStorage.getItem(DRAFT_KEY);
                if (!draftStr) return;

                if (confirm('Se encontró un borrador sin guardar. ¿Deseas restaurarlo?')) {
                    const draft = JSON.parse(draftStr);

                    // 1) Agrupar valores por nombre de campo
                    const formMap = draft.form.reduce((acc, { name, value }) => {
                        acc[name] = acc[name] || [];
                        acc[name].push(value);
                        return acc;
                    }, {});

                    // 2) Restaurar cada campo, usando array para selects múltiples
                    Object.entries(formMap).forEach(([name, values]) => {
                        const $el = $('[name="' + name + '"]');
                        const valToSet = $el.prop('multiple') ? values : values[0];
                        if ($el.hasClass('select2-hidden-accessible')) {
                            $el.val(valToSet).trigger('change');
                        } else {
                            $el.val(valToSet);
                        }
                    });

                    // 3) Restaurar detalle HTML
                    $('#tblDetalle tbody').html(draft.detalleHtml);

                    // 4) Corregir índices duplicados después de restaurar
                    var newIndex = 0;
                    $('#tblDetalle tbody tr[data-index]').each(function () {
                        var $row = $(this);
                        $row.attr('data-index', newIndex);
                        $row.find('.addSub').attr('data-index', newIndex);
                        $row.find('td:first').text(newIndex + 1);
                        $row.next('tr[data-parent]').attr('data-parent', newIndex);
                        newIndex++;
                    });

                    detalleIndex = newIndex;
                }
            }

            // Restaura al cargar y luego auto‑respalda cada 30s
            restoreIfExists();
            setInterval(backupForm, 30000);

            // ───────── PREVENT UNLOAD ─────────
            function beforeUnloadHandler(e) {
                const hasRows = $('#tblDetalle tbody tr').length > 0;
                const isDirty = $('#frmProduccion').serialize() !== '';
                if (hasRows || isDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            }
            window.addEventListener('beforeunload', beforeUnloadHandler);

            $('#btnRegresar').off('click').on('click', function () {
                const url = $(this).data('url');
                if (confirm('¿Deseas salir sin guardar? Se perderán los datos .')) {
                    localStorage.removeItem(DRAFT_KEY);
                    window.removeEventListener('beforeunload', beforeUnloadHandler);
                    window.location.href = url;
                }
            });

            var detalleIndex = 0;
            var currentDetalle = null;

            // --- INICIALIZACIÓN SELECT2 EN LA PÁGINA PRINCIPAL ---
            $("#IdUsuarios").select2({
                placeholder: "- Selecciona los operarios -",
                allowClear: true,
                width: '100%'
            });

            $("#IdMaquina").select2({
                placeholder: "- Selecciona la máquina -",
                allowClear: true,
                width: '100%'
            });

            $("#IdTipoFabricacion").select2({
                placeholder: "- Selecciona el tipo -",
                allowClear: true,
                width: '100%'
            });

            // Mostrar/ocultar Número de Pedido
            function toggleNumeroPedido() {
                var v = $('#IdTipoFabricacion').val();
                if (v == '2') {
                    $('#divNumeroPedido').show();
                } else {
                    $('#divNumeroPedido').hide();
                    $('#NumeroPedido').val('');
                }
            }
            $('#IdTipoFabricacion').on('change', toggleNumeroPedido);
            toggleNumeroPedido();

            // --- MANEJO DEL MODAL #1: Detalle ---
            $('#modal-Detalle').on('shown.bs.modal', function () {
                $(this).find('#MarcaTipo').trigger('focus');
            });

            $('#modal-SubDetalle').on('shown.bs.modal', function () {
                var $modal = $(this);
                
                // CORREGIDO: Verificar que currentDetalle esté definido antes de proceder
                if (currentDetalle === null || currentDetalle === undefined) {
                    console.warn('currentDetalle no está definido. Usando valores por defecto.');
                    $modal.find('#NoBatch').val(1);
                    $modal.find('#Silo').val(1);
                } else {
                    // Buscar específicamente la tabla correspondiente al currentDetalle
                    var $specificSubTable = $("tr[data-parent='" + currentDetalle + "']").find('table.subTable tbody');
                    
                    // CORREGIDO: Verificar que se encontró la tabla antes de continuar
                    if ($specificSubTable.length === 0) {
                        console.warn('No se encontró la subtabla para currentDetalle:', currentDetalle);
                        $modal.find('#NoBatch').val(1);
                        $modal.find('#Silo').val(1);
                    } else {
                        // Fijar valores iniciales por defecto
                        $modal.find('#NoBatch').val(1);
                        $modal.find('#Silo').val(1);
                    }
                }
                
                // Fijar la hora actual en formato HH:mm
                var now = new Date();
                var hh = String(now.getHours()).padStart(2, '0');
                var mm = String(now.getMinutes()).padStart(2, '0');
                $modal.find('#Hora').val(hh + ':' + mm);
                
                // Recalcular NoBatch basado en el Paso seleccionado por defecto
                setTimeout(function() {
                    recalcularNoBatch();
                }, 100);
            });

            // NUEVO: Función para recalcular NoBatch cuando cambia el Paso
            function recalcularNoBatch() {
                var $modal = $('#modal-SubDetalle');
                var selectedPaso = $modal.find('#Paso').val();
                
                if (currentDetalle === null || currentDetalle === undefined) {
                    $modal.find('#NoBatch').val(1);
                    return;
                }
                
                // Buscar específicamente la tabla correspondiente al currentDetalle
                var $specificSubTable = $("tr[data-parent='" + currentDetalle + "']").find('table.subTable tbody');
                
                if ($specificSubTable.length === 0) {
                    $modal.find('#NoBatch').val(1);
                    return;
                }
                
                // Contar cuántos registros hay con el mismo Paso en esa tabla específica
                var countSamePaso = 0;
                $specificSubTable.find('tr').each(function () {
                    var existingPaso = $(this).find('td:eq(20)').text(); // Columna hidden con valor de Paso
                    if (existingPaso === selectedPaso) {
                        countSamePaso++;
                    }
                });
                
                // El siguiente NoBatch para este Paso será el count + 1
                $modal.find('#NoBatch').val(countSamePaso + 1);
            }

            // Evento para recalcular NoBatch cuando cambia el Paso
            $(document).on('change', '#modal-SubDetalle #Paso', function () {
                recalcularNoBatch();
            });

            // Botón Guardar del primer modal (Detalle)
            $('#btnGuardarDetPrd').click(function () {
                var modalId = '#modal-Detalle';
                $(modalId + ' #spnbtnGuardarDetPrd').text('');

                var marcaTipo = $(modalId + ' #MarcaTipo').val();
                var codigoSaco = $(modalId + ' #CodigoSaco').val();
                var lote = $(modalId + ' #Lote').val();
                var fechaProduccion = $(modalId + ' #FechaProduccion').val();

                if (!marcaTipo) {
                    $(modalId + ' #spnbtnGuardarDetPrd').text('La Marca/Tipo es obligatoria.');
                    return;
                }

                var row = `<tr data-index="${detalleIndex}">
                            <td>${detalleIndex + 1}</td>
                            <td>${marcaTipo}</td>
                            <td>${codigoSaco || ''}</td>
                            <td>${lote || ''}</td>
                            <td>${fechaProduccion || ''}</td>
                            <td><a href="#" class="btn btn-sm btn-outline-primary addSub" data-index="${detalleIndex}">Agregar Sub</a></td>
                           </tr>
                           <tr data-parent="${detalleIndex}"><td colspan="6"><table class='table table-sm table-bordered subTable'>
                             <thead><tr><th>No. Batch</th><th>Hora</th><th>Dens. Esperada</th><th>Peso Batch (g)</th><th>Densidad</th><th>Kg/Batch</th><th>Presión (psi)</th><th>Tiempo (seg)</th><th>Temp (°C)</th><th>Silo</th><th>Paso</th></tr></thead>
                             <tbody></tbody></table></td></tr>`;

                $('#tblDetalle > tbody').append(row);

                detalleIndex++;
                $(modalId + ' #frmDetPrd')[0].reset();
                $(modalId).modal('hide');
            });

            // Abrir el modal de sub-detalle
            $(document).on('click', '.addSub', function (e) {
                e.preventDefault();

                var $clickedButton = $(this);
                currentDetalle = $clickedButton.data('index');
                
                $('#modal-SubDetalle').modal('show');
            });

            // Botón Guardar del segundo modal (Sub Detalle)
            $('#btnGuardarSubDetPrd').click(function () {
                var modalId = '#modal-SubDetalle';
                $(modalId + ' #spnSubDet').text('');

                var noBatch = $(modalId + ' #NoBatch').val();
                var hora = $(modalId + ' #Hora').val();
                var densEsp = $(modalId + ' #DensidadEsperada').val();
                var pesoGr = $(modalId + ' #PesoBatchGr').val();
                var dens = $(modalId + ' #Densidad').val();
                var kgBatch = $(modalId + ' #KgPorBatch').val();
                var psi = $(modalId + ' #PresionPsi').val();
                var seg = $(modalId + ' #TiempoBatchSeg').val();
                var tempC = $(modalId + ' #TemperaturaC').val();
                var silo = $(modalId + ' #Silo').val();
                var paso = $(modalId + ' #Paso').val();
                var pasoTxt = $(modalId + ' #Paso option:selected').text();

                // Convertir "hora" (24h) a formato "hh:mm:00 AM/PM"
                var rawHora = hora;
                var parts = rawHora.split(':');
                var h24 = parseInt(parts[0], 10), m = parts[1];
                var ampm = h24 >= 12 ? 'PM' : 'AM';
                var h12 = (h24 % 12) || 12;
                var formattedHora = ('0' + h12).slice(-2) + ':' + m + ':00 ' + ampm;
                var rawHora24 = ('0' + h24).slice(-2) + ':' + m + ':00';

                if (!noBatch || !hora || !densEsp || !pesoGr || !dens || !kgBatch || !psi || !seg || !tempC || !silo || !paso) {
                    $(modalId + ' #spnSubDet').text('Complete todos los campos obligatorios');
                    return;
                }

                var row = `<tr>
                            <td>${noBatch}</td>
                            <td data-hora="${rawHora24}">${formattedHora}</td>
                            <td>${densEsp}</td>
                            <td>${pesoGr}</td>
                            <td>${dens}</td>
                            <td>${kgBatch}</td>
                            <td>${psi}</td>
                            <td>${seg}</td>
                            <td>${tempC}</td>
                            <td>${silo}</td>
                            <td>${pasoTxt}</td>
                            <td style='display:none'>${rawHora24}</td>
                            <td style='display:none'>${densEsp}</td>
                            <td style='display:none'>${pesoGr}</td>
                            <td style='display:none'>${dens}</td>
                            <td style='display:none'>${kgBatch}</td>
                            <td style='display:none'>${psi}</td>
                            <td style='display:none'>${seg}</td>
                            <td style='display:none'>${tempC}</td>
                            <td style='display:none'>${silo}</td>
                            <td style='display:none'>${paso}</td>
                       </tr>`;
                       
                // CORREGIDO: Buscar específicamente la tabla correspondiente al currentDetalle
                var $targetSubTable = $("tr[data-parent='" + currentDetalle + "']").find('table.subTable tbody');
                
                // Verificar que se encontró la tabla correcta
                if ($targetSubTable.length === 0) {
                    $(modalId + ' #spnSubDet').text('Error: No se pudo encontrar la tabla destino');
                    return;
                }
                
                // Agregar la fila SOLO a la tabla específica
                $targetSubTable.append(row);

                $(modalId + ' #frmSubDetPrd')[0].reset();
                $(modalId).modal('hide');
            });

            $('#frmProduccion').submit(function (e) {
                e.preventDefault();


                // Validaciones
                const usuariosSeleccionados = $('#IdUsuarios').val();
                const maquinaSeleccionada = $('#IdMaquina').val();

                if (!usuariosSeleccionados || usuariosSeleccionados.length === 0) {
                    alert("Debe seleccionar al menos un operario.");
                    return;
                }

                if (!maquinaSeleccionada || maquinaSeleccionada === "") {
                    alert("Debe seleccionar una máquina.");
                    return;
                }

                var token = $('input[name="__RequestVerificationToken"]').val();
                
                // Convertir horas
                function convertirHora(hora24) {
                    if (!hora24) return null;
                    var parts = hora24.split(':');
                    var h24 = parseInt(parts[0], 10);
                    var m = parts[1];
                    return ('0' + h24).slice(-2) + ':' + m + ':00';
                }
                
                var horaInicioVal = $('#HoraInicio').val();
                var horaFinVal = $('#HoraFin').val();
                
                var viewModel = { 
                    IdUsuarios: $('#IdUsuarios').val(), 
                    IdMaquina: $('#IdMaquina').val() ? parseInt($('#IdMaquina').val()) : 0,
                    Fecha: $('#Fecha').val(),
                    HoraInicio: convertirHora(horaInicioVal),
                    HoraFin: convertirHora(horaFinVal),
                    PresionCaldera: $('#PresionCaldera').val(),
                    IdTipoFabricacion: $('#IdTipoFabricacion').val() ? parseInt($('#IdTipoFabricacion').val()) : 0,
                    NumeroPedido: $('#NumeroPedido').val() ? parseInt($('#NumeroPedido').val()) : null,
                    Observaciones: $('#Observaciones').val(),
                    TiempoParo: $('#TiempoParo').val() ? parseFloat($('#TiempoParo').val()) : null,
                    PreDetPrdPreExpansions: [] 
                };
                
                $('#tblDetalle tbody tr[data-index]').each(function () {
                    var idx = $(this).data('index');
                    var det = { 
                        MarcaTipo: $(this).find('td:eq(1)').text(),
                        CodigoSaco: $(this).find('td:eq(2)').text() || null,
                        Lote: $(this).find('td:eq(3)').text() || null,
                        FechaProduccion: $(this).find('td:eq(4)').text() || null,
                        DetPrdPreExpansions: [] 
                    };
                    
                    $("tr[data-parent='" + idx + "'] table.subTable tbody tr").each(function () {
                        var sd = {
                            NoBatch: parseInt($(this).find('td:eq(0)').text()),
                            Hora: $(this).find('td:eq(11)').text(),
                            DensidadEsperada: parseInt($(this).find('td:eq(12)').text()),
                            PesoBatchGr: parseFloat($(this).find('td:eq(13)').text()),
                            Densidad: parseFloat($(this).find('td:eq(14)').text()),
                            KgPorBatch: parseInt($(this).find('td:eq(15)').text()),
                            PresionPsi: parseInt($(this).find('td:eq(16)').text()),
                            TiempoBatchSeg: parseInt($(this).find('td:eq(17)').text()),
                            TemperaturaC: parseInt($(this).find('td:eq(18)').text()),
                            Silo: parseInt($(this).find('td:eq(19)').text()),
                            Paso: parseInt($(this).find('td:eq(20)').text())
                        };
                        det.DetPrdPreExpansions.push(sd);
                    });
                    viewModel.PreDetPrdPreExpansions.push(det);
                });

                if (viewModel.PreDetPrdPreExpansions.length === 0) {
                    alert('Debe agregar al menos un detalle de producción.');
                    return;
                }

                $.ajax({
                    url: '/PrdPreExpansion/Create',
                    type: 'POST',
                    headers: { 'RequestVerificationToken': token },
                    data: JSON.stringify(viewModel),
                    contentType: 'application/json; charset=utf-8',
                    success: function () {
                        localStorage.removeItem(DRAFT_KEY);
                        window.removeEventListener('beforeunload', beforeUnloadHandler);
                        alert('Producción Guardada!');
                        window.location.href = '@Url.Action("Index", "Home")';
                    },
                    error: function () {
                        alert('Error , Contacte a soporte!');
                    }
                });
            });
        });
    </script>
}

@functions {
    public static string To12HourFormat(TimeSpan hora)
    {
        var dateTime = DateTime.Today.Add(hora);
        return dateTime.ToString("hh:mm tt");
    }
}

