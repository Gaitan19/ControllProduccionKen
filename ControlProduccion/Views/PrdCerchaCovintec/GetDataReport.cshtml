@using Infrastructure.DTO
@model IEnumerable<PrdCerchaCovintecReporteDTO>

@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
    ViewData["Title"] = "Reporte Cercha Covintec";
}
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f6f8fa;
        margin: 0;
        padding: 0;
    }

    .container {
        width: 90%;
        max-width: 1200px;
        margin: 20px auto;
        background-color: #fff;
        padding: 20px;
        border-radius: 6px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    h1 {
        text-align: center;
        margin-bottom: 30px;
    }

    /* Encabezado del reporte */
    .report-header {
        border-collapse: collapse;
        width: auto; /* ancho dinámico según contenido */
        table-layout: auto; /* se ajusta al contenido */
        margin-bottom: 25px;
    }

        .report-header thead th {
            background-color: #f2f2f2;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px 15px;
            text-align: left;
            white-space: nowrap; /* evita que el texto salte de línea */
        }

        .report-header td,
        .report-header th {
            border: 1px solid #e1e1e1;
            padding: 8px 15px;
            white-space: nowrap;
        }

    .header-title {
        font-weight: bold;
        background-color: #b0f7cc;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 4px;
    }

    /* Secciones de Detalles */
    .section-title {
        font-weight: bold;
        padding: 12px;
        background-color: #d9ecff;
        margin-top: 20px;
        margin-bottom: 5px;
        border-radius: 4px;
    }

    .details-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

        .details-table th {
            background-color: #f2f2f2;
            text-transform: uppercase;
            font-weight: bold;
            padding: 10px 12px;
            text-align: left;
            border: 1px solid #e1e1e1;
        }

        .details-table td {
            border: 1px solid #e1e1e1;
            padding: 10px 12px;
        }

    /* Sección de firmas */
    .signatures {
        margin-top: 40px;
    }

        .signatures table {
            width: 100%;
            border-collapse: collapse;
        }

        .signatures td {
            padding-top: 40px;
            text-align: center;
            vertical-align: bottom;
        }

    .signature-line {
        border-top: 1px solid #000;
        width: 60%; /* Línea un poco más corta */
        margin: 0 auto 5px auto;
    }

    .signature-label {
        display: block;
        text-align: center;
        font-weight: bold;
    }

    .ibox-title {
        display: flex;
        align-items: center;
    }

        .ibox-title .col-sm-3 {
            flex: 0 0 auto;
            margin-right: 15px;
        }
</style>


<div class="col-md-15 offset-md-1">

    <div class="ibox">
        <div class="ibox-title">

            <div class="col-sm-3">

                <input id="datesReport" name="datesReport" runat="server" autocomplete="off" class="form-control" />

            </div>
            <div class="col-sm-3">  <button id="btnDescargar" class="dt-button buttons-csv buttons-html5 btn btn-outline btn-success btn-xs" tabindex="0" aria-controls="DataTables_Table_0" type="button"><span><i class="fa fa-download"></i> .PDF</span></button></div>

        </div>
        <div id="divMainReportAll" class="ibox-content table-responsive">



         
            @foreach (var reporte in Model)
            {

                    <div class="report-page">
                        <!-- Encabezado del Reporte -->
                    <h1>Reporte de Producción Cercha Covintec</h1>
                    @*   <div class="header-title">Reporte Id:@reporte.Id</div> *@
                        <img src="~/logoEcotec.png" alt="Logo Ecotec" style="width:150px; height:50px;">
                        <br />
                        <br />
                        <table class="report-header">
                            <thead>
                                <tr>
                                    <th>CAMPO</th>
                                    <th>VALOR</th>
                                </tr>
                            </thead>
                            <tbody>

                                <tr>
                                    <td>Operarios</td>
                                    <td>@reporte.Operarios</td>
                                </tr>
                                <tr>
                                    <td>Fecha</td>
                                    <td>@reporte.Fecha.ToString("yyyy-MM-dd")</td>
                                </tr>
                                  <tr>
                                    <td>Conteo Inicial</td>
                                    <td>@reporte.ConteoInicial</td>
                                </tr>
                            <tr>
                                <td>Conteo Final</td>
                                <td>@reporte.ConteoFinal</td>
                            </tr>
                                <tr>
                                    <td>Máquina</td>
                                    <td>@reporte.Maquina</td>
                                </tr>
                                <tr>
                                    <td>Observaciones</td>
                                    <td>@reporte.Observaciones</td>
                                </tr>
                                <tr>
                                    <td>Merma Alambre (KG)</td>
                                    <td>@reporte.MermaAlambre</td>
                                </tr>
                                <tr>
                                    <td>Validador</td>
                                    <td>@reporte.Supervisor</td>
                                </tr>
                                <tr>
                                    <td>Jefe Producción</td>
                                    <td>@reporte.JefeProd</td>
                                </tr>
                                <tr>
                                    <td>Tiempo Paro (Horas)</td>
                                    <td>@reporte.TiempoParo</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Detalles de Paneles -->
                        <div class="section-title">Detalles de Paneles</div>
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th>Artículo</th>
                                    <th>Cant. Prod.</th>
                                    <th>Cant. No Conforme</th>
                                    <th>Tipo Fabricación</th>
                                    <th>N° Pedido</th>
                                    <th>Producción Día</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var panel in reporte.DetallesPanel)
                            {
                                        <tr>
                                            <td>@panel.Articulo</td>
                                            <td>@panel.CantidadProducida</td>
                                            <td>@panel.CantidadNoConforme</td>
                                            <td>@panel.TipoFabricacion</td>
                                            <td>@panel.NumeroPedido</td>
                                            <td>@panel.ProduccionDia</td>
                                        </tr>
                            }
                            </tbody>
                        </table>

                        <!-- Detalles de Alambre -->
                        <div class="section-title">Detalles de Alambre</div>
                        <table class="details-table">
                            <thead>
                                <tr>
                                    <th>Número Alambre</th>
                                    <th>Peso Alambre</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var alambre in reporte.DetallesAlambre)
                            {
                                        <tr>
                                            <td>@alambre.NumeroAlambre</td>
                                            <td>@alambre.PesoAlambre</td>
                                        </tr>
                            }
                            </tbody>
                        </table>
                    @if (reporte == Model.Last())
                    {
                                <!-- Sección de Firmas -->
                                <div class="signatures">
                                    <table>
                                        <tr>
                                            <td>
                                                <div class="signature-line"></div>
                                                <span class="signature-label">Operario</span>
                                            </td>
                                            <td>
                                                <div class="signature-line"></div>
                                                <span class="signature-label">Validador</span>
                                            </td>
                                            <td>
                                                <div class="signature-line"></div>
                                                <span class="signature-label">Jefe de Producción</span>
                                            </td>
                                        </tr>
                                    </table>
                                </div>
                    }

                 </div>
            }


        </div>
    </div>
</div>




@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");

        var startParam = ViewContext.HttpContext.Request.Query["start"].ToString();
        var endParam = ViewContext.HttpContext.Request.Query["end"].ToString();

        // var defaultStartDate = string.IsNullOrEmpty(startParam)
        //     ? DateTime.Now.AddDays(-1).ToString("MM/dd/yyyy")
        //     : startParam;

        // var defaultEndDate = string.IsNullOrEmpty(endParam)
        //     ? DateTime.Now.ToString("MM/dd/yyyy")
        //     : endParam;



        // Parse and validate date parameters

        DateTime startDate, endDate;

        if (!DateTime.TryParse(startParam, out startDate) || startDate < new DateTime(1753, 1, 1))
        {

            startDate = DateTime.Now.AddDays(-1);
        }

        if (!DateTime.TryParse(endParam, out endDate) || endDate < new DateTime(1753, 1, 1))
        {
            endDate = DateTime.Now;
        }

        var defaultStartDate = startDate.ToString("MM/dd/yyyy");

        var defaultEndDate = endDate.ToString("MM/dd/yyyy");
    }
        <script src="~/js/html2canvas.min.js"></script>
        <script src="~/js/jspdf.umd.min.js"></script>
        <script>
                     $(function () {
              var start = moment('@defaultStartDate');
            var end = moment('@defaultEndDate');

                $('#datesReport').daterangepicker({
                    startDate: start,
                    endDate: end,
                    ranges: {
                        'Hoy': [moment(), moment()],
                        'Ayer': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                        'Ultimos 7 dias': [moment().subtract(6, 'days'), moment()],
                        'Ultimos 30 dias': [moment().subtract(29, 'days'), moment()],
                        'Este Mes': [moment().startOf('month'), moment().endOf('month')],
                        'Mes pasado': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                    }
                });

                // Al aplicar un nuevo rango, se redirige a la acción con los parámetros
                $('#datesReport').on('apply.daterangepicker', function(ev, picker) {
                window.location.href = '@Url.Action("GetDataReport", "PrdCerchaCovintec")'
                        + '?start=' + picker.startDate.format('YYYY-MM-DD')
                        + '&end=' + picker.endDate.format('YYYY-MM-DD');
                });
            });


                     document.getElementById('btnDescargar').addEventListener('click', async function() {
              // Crear una instancia de jsPDF
              var pdf = new jspdf.jsPDF('p', 'mm', 'letter');
              var pageWidth = pdf.internal.pageSize.getWidth();
              var pageHeight = pdf.internal.pageSize.getHeight();

              // Selecciona todos los contenedores de reporte
              var reportPages = document.querySelectorAll('.report-page');

                    // --- Inicio: Modificación Temporal ---
            const originalStyles = []; // Para guardar los estilos originales
            const fixedWidth = '1024px'; // O el ancho que consideres "escritorio" o necesario para ver todo

            reportPages.forEach(page => {
                originalStyles.push({ element: page, style: page.style.cssText }); // Guarda estilo inline actual
                page.style.width = fixedWidth;
                page.style.maxWidth = fixedWidth; // Asegura que no se limite por otras reglas
                // Podrías necesitar añadir más estilos aquí para forzar la visibilidad
                // de elementos que se ocultan en móvil, por ejemplo:
                // page.querySelectorAll('.elemento-oculto-en-movil').forEach(el => el.style.display = 'block');
            });
            // --- Fin: Modificación Temporal ---


              // Procesa cada reporte individualmente
              var isFirstPdfPage = true; // Controla si agregamos nueva página
              for (var i = 0; i < reportPages.length; i++) {
                // Renderiza el contenedor actual en un canvas con html2canvas
                        var canvasOptions = {
                scale: 2, // Mejora resolución
                useCORS: true,
                // Intenta simular un viewport más ancho
                windowWidth: 1200, // Un ancho típico de escritorio en píxeles
                // Opcional: Forzar el ancho del canvas resultante (puede escalar, no siempre arregla layout)
                // width: 1200,
                scrollX: 0,
                scrollY: -window.scrollY // Capturar desde la parte superior
            };

                var canvas = await html2canvas(reportPages[i], canvasOptions);

                // Ajustar la imagen respetando márgenes y múltiples páginas
                var margin = 10; // margen en mm
                var canvasWidth = canvas.width;
                var canvasHeight = canvas.height;
                var imgWidth = pageWidth - margin * 2;
                var scale = imgWidth / canvasWidth;
                var pageHeightAvailable = pageHeight - margin * 2;
                var sliceHeight = pageHeightAvailable / scale; // Alto en px de cada página

                var pageCanvas = document.createElement('canvas');
                var pageCtx = pageCanvas.getContext('2d');
                pageCanvas.width = canvasWidth;

                var renderedHeight = 0;
                while (renderedHeight < canvasHeight) {
                    var currentHeight = Math.min(sliceHeight, canvasHeight - renderedHeight);
                    pageCanvas.height = currentHeight;
                    pageCtx.clearRect(0, 0, canvasWidth, currentHeight);
                    pageCtx.drawImage(canvas, 0, renderedHeight, canvasWidth, currentHeight, 0, 0, canvasWidth, currentHeight);
                    var imgData = pageCanvas.toDataURL('image/png');

                    if (!isFirstPdfPage) {
                        pdf.addPage();
                    }

                    pdf.addImage(imgData, 'PNG', margin, margin, imgWidth, currentHeight * scale);
                    renderedHeight += currentHeight;
                    isFirstPdfPage = false;
                }
              }

              // Restaurar estilos originales
              reportPages.forEach((page, idx) => {
                  page.style.cssText = originalStyles[idx].style;
              });

              // Opcional: Si deseas que la sección de firmas se muestre en la última página,
              // podrías capturarla y agregarla después de procesar todos los reportes.
              // var signatures = document.querySelector('.signatures');
              // if (signatures) {
              //   var canvasSign = await html2canvas(signatures);
              //   var signImgData = canvasSign.toDataURL('image/png');
              //   var canvasSignWidth = canvasSign.width;
              //   var canvasSignHeight = canvasSign.height;
              //   var ratioSign = pageWidth / canvasSignWidth;
              //   var signImgHeight = canvasSignHeight * ratioSign;

              //   pdf.addPage();
              //   pdf.addImage(signImgData, 'PNG', 0, 0, pageWidth, signImgHeight);
              // }

              pdf.save('ReporteProduccionCerchaCovintec.pdf');
            });

        </script>

}



